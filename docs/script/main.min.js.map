{"version":3,"file":"main.min.js","mappings":"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","sources":["webpack://non-circular-gears/./src/ts/engine/angle-utils.ts","webpack://non-circular-gears/./src/ts/engine/gear.ts","webpack://non-circular-gears/./src/ts/engine/polar-curves.ts","webpack://non-circular-gears/./src/ts/engine/rays.ts","webpack://non-circular-gears/./src/ts/parameters.ts","webpack://non-circular-gears/./src/ts/scenes/random-scene.ts","webpack://non-circular-gears/./src/ts/scenes/scene.ts","webpack://non-circular-gears/./src/ts/svg-canvas.ts","webpack://non-circular-gears/./src/ts/utils.ts","webpack://non-circular-gears/webpack/bootstrap","webpack://non-circular-gears/./src/ts/main.ts"],"sourcesContent":["const TWO_PI = 2 * Math.PI;\r\n\r\nfunction makeAnglePositive(angle: number): number {\r\n    if (angle < 0) {\r\n        angle += TWO_PI * Math.ceil(-angle / TWO_PI);\r\n    }\r\n    return angle;\r\n}\r\nfunction normalizeAngle(angle: number): number {\r\n    angle = makeAnglePositive(angle);\r\n    return angle % TWO_PI;\r\n}\r\n\r\nfunction toDegrees(angleInRadians: number): number {\r\n    return 180 / Math.PI * angleInRadians;\r\n}\r\n\r\nfunction toRadians(angleInDegrees: number): number {\r\n    return Math.PI / 180 * angleInDegrees;\r\n}\r\n\r\nfunction angleDifference(angle1: number, angle2: number): number {\r\n    const rawDifference = normalizeAngle(angle2 - angle1);\r\n    if (rawDifference <= Math.PI) {\r\n        return rawDifference;\r\n    }\r\n    return TWO_PI - rawDifference;\r\n}\r\n\r\nexport {\r\n    angleDifference,\r\n    makeAnglePositive,\r\n    normalizeAngle,\r\n    toDegrees,\r\n    toRadians,\r\n    TWO_PI,\r\n};\r\n\r\n","import { normalizeAngle, toDegrees, TWO_PI } from \"./angle-utils\";\r\nimport type { Point, Vector } from \"./point\";\r\nimport type { PolarCurve } from \"./polar-curves\";\r\nimport { computeDeltaAngle, computeDistance, computeNormal, type Ray, type ReadonlyRay } from \"./rays\";\r\n\r\ntype ReadonlyPoint = {\r\n    readonly x: number;\r\n    readonly y: number;\r\n};\r\n\r\ntype ConstructionResult = {\r\n    distance: number;\r\n    periodRays: Ray[];\r\n    period: number; // can be fractional\r\n    targetPeriod: number; // integer\r\n    error: number; // in [0, 1]\r\n};\r\n\r\ntype Segment = {\r\n    readonly startingRay: ReadonlyRay;\r\n    readonly nextRay: ReadonlyRay;\r\n    readonly deltaAngle: number; // between starting and next rays\r\n    readonly deltaDistance: number; // between starting and next rays\r\n};\r\n\r\ntype SurfaceFragment = {\r\n    point: Point;\r\n    normal: Vector;\r\n};\r\n\r\nenum ESurfaceType {\r\n    NONE,\r\n    SMOOTH,\r\n    TEETH_SMALL,\r\n    TEETH_MEDIUM,\r\n    TEETH_LARGE,\r\n}\r\n\r\ntype SvgRepresentation = {\r\n    readonly container: SVGElement;\r\n    readonly rotationElement: SVGElement;\r\n    readonly gearElement: SVGElement;\r\n    currentSurfaceType: ESurfaceType;\r\n    computedPaths: Record<number, string>;\r\n};\r\n\r\nclass Gear {\r\n    public static readonly centerRadius = 0.015;\r\n\r\n    public static readonly gearClass: string = \"gear\";\r\n    public static readonly gearMainClass: string = \"main\";\r\n    public static readonly gearRaysClass: string = \"gear-rays\";\r\n    public static readonly gearAxisClass: string = \"gear-axis\";\r\n\r\n    public static create(center: ReadonlyPoint, polarCurve: PolarCurve): Gear {\r\n        return new Gear(center, polarCurve.periodRays, polarCurve.periodsCount, +1, null);\r\n    }\r\n\r\n    public static slaveGear(idealCenter: ReadonlyPoint, master: Gear): Gear | null {\r\n        const dX = idealCenter.x - master.center.x;\r\n        const dY = idealCenter.y - master.center.y;\r\n        const idealDistance = Math.max(master.maxRadius + 0.01, Math.sqrt(dX * dX + dY * dY));\r\n\r\n        const adjustedDistance = Gear.getNextFittingDistance(idealDistance, master);\r\n        const period = Gear.tryBuildCompanionPeriod(adjustedDistance, master);\r\n\r\n        const angle = Math.atan2(dY, dX);\r\n        const center = {\r\n            x: master.center.x + adjustedDistance * Math.cos(angle),\r\n            y: master.center.y + adjustedDistance * Math.sin(angle),\r\n        };\r\n        const newGear = new Gear(center, period.periodRays, period.targetPeriod, -master.orientation, master);\r\n\r\n        return newGear;\r\n    }\r\n\r\n    private static tryBuildCompanionPeriod(distance: number, master: Gear): ConstructionResult {\r\n        const periodRays: Ray[] = [];\r\n        let angle = 0;\r\n\r\n        for (const periodSegment of master.periodSegments) {\r\n            periodRays.push({\r\n                angle,\r\n                radius: distance - periodSegment.startingRay.radius,\r\n            });\r\n\r\n            const dSegmentLengthSquared = periodSegment.deltaDistance * periodSegment.deltaDistance;\r\n\r\n            const r1 = distance - periodSegment.startingRay.radius;\r\n            const r2 = distance - periodSegment.nextRay.radius;\r\n            const dAngle = Math.acos((r1 * r1 + r2 * r2 - dSegmentLengthSquared) / (2 * r1 * r2));\r\n            if (isNaN(dAngle)) {\r\n                throw new Error(\"Should not happen\");\r\n            }\r\n\r\n            angle += dAngle;\r\n        }\r\n\r\n        if (master.orientation > 0) {\r\n            for (const periodRay of periodRays) {\r\n                periodRay.angle = Math.PI - periodRay.angle;\r\n            }\r\n        }\r\n\r\n        const period = TWO_PI / angle;\r\n        const targetPeriod = Math.ceil(period);\r\n        const error = targetPeriod - period;\r\n        return {\r\n            distance,\r\n            periodRays,\r\n            period,\r\n            targetPeriod,\r\n            error,\r\n        };\r\n    }\r\n\r\n    private static getNextFittingDistance(idealDistance: number, master: Gear): number {\r\n        const initialTry = Gear.tryBuildCompanionPeriod(idealDistance, master);\r\n\r\n        let tooLowTry = initialTry;\r\n        let tooHighTry = null as ConstructionResult | null;\r\n\r\n        const maxTries = 200;\r\n        let triesCount = 1;\r\n        while (tooLowTry.error > 0 && triesCount < maxTries) {\r\n            const currentDistance = tooHighTry ? 0.5 * (tooLowTry.distance + tooHighTry.distance) : tooLowTry.distance + 0.5;\r\n            if (currentDistance === tooLowTry.distance || currentDistance === tooHighTry?.distance) {\r\n                // console.debug(\"Convergence\");\r\n                break;\r\n            }\r\n\r\n            const currentTry = Gear.tryBuildCompanionPeriod(currentDistance, master);\r\n            if (currentTry.targetPeriod > tooLowTry.targetPeriod || currentTry.error > tooLowTry.error) {\r\n                tooHighTry = currentTry;\r\n            } else {\r\n                tooLowTry = currentTry;\r\n            }\r\n            triesCount++;\r\n        }\r\n\r\n        const finalTry = tooLowTry;\r\n        // console.debug(`Final error ${finalTry.error} obtained in ${triesCount} tries. Final periodicity ${finalTry.targetPeriod}, initial was ${initialTry.targetPeriod}.`);\r\n        return finalTry.distance;\r\n    }\r\n\r\n    private readonly svgRepresentation: SvgRepresentation;\r\n    public get svgElement(): SVGElement {\r\n        return this.svgRepresentation.container;\r\n    }\r\n\r\n    private readonly periodSegments: ReadonlyArray<Segment>;\r\n    private readonly periodSegmentsReverse: ReadonlyArray<Segment>;\r\n    private readonly periodAngle: number;\r\n    private readonly periodSurface: number;\r\n    public readonly minRadius: number;\r\n    public readonly maxRadius: number;\r\n    private rotation: number = 0;\r\n\r\n    private constructor(\r\n        public readonly center: ReadonlyPoint,\r\n        periodRays: ReadonlyArray<Ray>,\r\n        private readonly periodsCount: number,\r\n        private readonly orientation: number,\r\n        private readonly parent: Gear | null) {\r\n        let minRadius = 10000000000;\r\n        let maxRadius = -10000000000;\r\n        periodRays.forEach(ray => {\r\n            ray.angle = normalizeAngle(ray.angle);\r\n            minRadius = Math.min(ray.radius, minRadius);\r\n            maxRadius = Math.max(ray.radius, maxRadius);\r\n        });\r\n        this.minRadius = minRadius;\r\n        this.maxRadius = maxRadius;\r\n\r\n        this.periodAngle = TWO_PI / this.periodsCount;\r\n\r\n        const firstPeriodRay = periodRays[0];\r\n        if (!firstPeriodRay) {\r\n            throw new Error();\r\n        }\r\n        this.periodSegments = periodRays.map((currentRay: Ray, index: number) => {\r\n            let nextRay = periodRays[index + 1];\r\n            if (!nextRay) {\r\n                nextRay = {\r\n                    angle: firstPeriodRay.angle + this.orientation * this.periodAngle,\r\n                    radius: firstPeriodRay.radius,\r\n                };\r\n            }\r\n\r\n            const deltaAngle = computeDeltaAngle(nextRay, currentRay);\r\n            const deltaDistance = computeDistance(nextRay, currentRay);\r\n\r\n            return {\r\n                startingRay: { angle: currentRay.angle, radius: currentRay.radius },\r\n                nextRay,\r\n                deltaAngle,\r\n                deltaDistance,\r\n            };\r\n        });\r\n        this.periodSegmentsReverse = this.periodSegments.slice().reverse();\r\n\r\n        this.periodSurface = 0;\r\n        for (const segment of this.periodSegments) {\r\n            this.periodSurface += segment.deltaDistance;\r\n        }\r\n\r\n        this.svgRepresentation = this.buildSvgRepresentation();\r\n    }\r\n\r\n    public rotate(rotation: number): void {\r\n        if (this.parent) {\r\n            throw new Error(\"Cannot rotate child gear.\");\r\n        }\r\n        this.setRotationInternal(this.rotation + rotation);\r\n    }\r\n\r\n    public update(): void {\r\n        if (!this.parent) {\r\n            return; // nothing to do\r\n        }\r\n\r\n        const previousMasterAngle = this.parent.rotation;\r\n        {\r\n            let relativeRotation = Math.atan2(this.center.y - this.parent.center.y, this.center.x - this.parent.center.x);\r\n            if (this.orientation > 0) {\r\n                relativeRotation = Math.PI + relativeRotation;\r\n            }\r\n            this.parent.setRotationInternal(this.parent.rotation - relativeRotation);\r\n            const surfaceRotation = this.parent.getCurrentRotatedSurface();\r\n            this.rotateFromSurface(surfaceRotation);\r\n            this.setRotationInternal(this.rotation + relativeRotation);\r\n        }\r\n        this.parent.rotation = previousMasterAngle;\r\n    }\r\n\r\n    public updateDisplay(surfaceType: ESurfaceType): void {\r\n        this.svgRepresentation.rotationElement.setAttribute(\"transform\", `rotate(${toDegrees(this.rotation)})`);\r\n\r\n        if (this.svgRepresentation.currentSurfaceType !== surfaceType) {\r\n            const showTeeth = [ESurfaceType.TEETH_SMALL, ESurfaceType.TEETH_MEDIUM, ESurfaceType.TEETH_LARGE].includes(surfaceType);\r\n            if (showTeeth) {\r\n                let path = this.svgRepresentation.computedPaths[surfaceType];\r\n                if (!path) {\r\n                    let idealToothSize;\r\n                    if (surfaceType === ESurfaceType.TEETH_SMALL) {\r\n                        idealToothSize = 0.02;\r\n                    } else if (surfaceType === ESurfaceType.TEETH_MEDIUM) {\r\n                        idealToothSize = 0.04;\r\n                    } else {\r\n                        idealToothSize = 0.06;\r\n                    }\r\n                    const periodPoints = this.buildPeriodPointsWithTeeth(idealToothSize);\r\n                    path = this.buildSvgPath(periodPoints);\r\n                    this.svgRepresentation.computedPaths[surfaceType] = path;\r\n                }\r\n                this.svgRepresentation.gearElement.setAttribute(\"d\", path);\r\n            } else {\r\n                let path = this.svgRepresentation.computedPaths[ESurfaceType.SMOOTH];\r\n                if (!path) {\r\n                    const periodPoints = this.buildPeriodPointsSmooth();\r\n                    path = this.buildSvgPath(periodPoints);\r\n                    this.svgRepresentation.computedPaths[surfaceType] = path;\r\n                }\r\n                this.svgRepresentation.gearElement.setAttribute(\"d\", path);\r\n            }\r\n\r\n            this.svgRepresentation.currentSurfaceType = surfaceType;\r\n        }\r\n    }\r\n\r\n    public isPointInside(position: ReadonlyPoint): boolean {\r\n        const dX = position.x - this.center.x;\r\n        const dY = position.y - this.center.y;\r\n        const d = dX * dX + dY * dY;\r\n        return d < this.minRadius * this.minRadius;\r\n    }\r\n\r\n    public isChildOf(otherGear: Gear): boolean {\r\n        let current: Gear | null = this; // eslint-disable-line @typescript-eslint/no-this-alias\r\n        while (current) {\r\n            if (current === otherGear) {\r\n                return true;\r\n            }\r\n            current = current.parent;\r\n        }\r\n        return false;\r\n    }\r\n\r\n    private setRotationInternal(rotation: number): void {\r\n        this.rotation = normalizeAngle(rotation);\r\n    }\r\n\r\n    private getCurrentRotatedSurface(): number {\r\n        const nbPeriods = Math.floor(this.rotation / this.periodAngle);\r\n        let cumulatedAngle = this.periodAngle * nbPeriods;\r\n        let cumulatedSurface = this.periodSurface * nbPeriods;\r\n\r\n        const periodSegments = (this.orientation > 0) ? this.periodSegmentsReverse : this.periodSegments;\r\n        for (const segment of periodSegments) {\r\n            const nextCumulatedAngle = cumulatedAngle + segment.deltaAngle;\r\n            const nextCumulatedSurface = cumulatedSurface + segment.deltaDistance;\r\n\r\n            if (nextCumulatedAngle >= this.rotation) {\r\n                let partial = 0;\r\n                if (segment.deltaAngle > 0) {\r\n                    partial = (nextCumulatedAngle - this.rotation) / segment.deltaAngle * segment.deltaDistance; // approximation\r\n                }\r\n                return cumulatedSurface + partial;\r\n            }\r\n\r\n            cumulatedAngle = nextCumulatedAngle;\r\n            cumulatedSurface = nextCumulatedSurface;\r\n        }\r\n        throw new Error();\r\n    }\r\n\r\n    private rotateFromSurface(targetSurface: number): void {\r\n        const nbPeriods = Math.floor(targetSurface / this.periodSurface);\r\n        this.rotation = -this.periodAngle * nbPeriods;\r\n        let cumulatedSurface = this.periodSurface * nbPeriods;\r\n\r\n        const periodSegments = (this.orientation < 0) ? this.periodSegmentsReverse : this.periodSegments;\r\n        for (const segment of periodSegments) {\r\n            const nextCumulatedSurface = cumulatedSurface + segment.deltaDistance;\r\n\r\n            if (nextCumulatedSurface >= targetSurface) {\r\n                if (segment.deltaDistance > 0) {\r\n                    const partial = (nextCumulatedSurface - targetSurface) / segment.deltaDistance * segment.deltaAngle; // approximation\r\n                    this.rotation -= partial;\r\n                }\r\n                return;\r\n            }\r\n\r\n            cumulatedSurface = nextCumulatedSurface;\r\n            this.rotation -= segment.deltaAngle;\r\n        }\r\n\r\n        throw new Error();\r\n    }\r\n\r\n    private *walkOnPeriod(stepSize: number): Generator<SurfaceFragment> {\r\n        let positionOnSegment = 0;\r\n        for (const periodSegment of this.periodSegments) {\r\n            const normal = computeNormal(periodSegment.startingRay, periodSegment.nextRay);\r\n\r\n            while (positionOnSegment < periodSegment.deltaDistance) {\r\n                const x = positionOnSegment / periodSegment.deltaDistance; // relative advancement\r\n\r\n                const angle = periodSegment.startingRay.angle + this.orientation * x * periodSegment.deltaAngle;\r\n                const radius = periodSegment.startingRay.radius + x * (periodSegment.nextRay.radius - periodSegment.startingRay.radius);\r\n                const point = {\r\n                    x: radius * Math.cos(angle),\r\n                    y: radius * Math.sin(angle),\r\n                };\r\n                yield { point, normal };\r\n                positionOnSegment += stepSize;\r\n            }\r\n\r\n            positionOnSegment -= periodSegment.deltaDistance;\r\n        }\r\n    }\r\n\r\n    private buildPeriodPointsSmooth(): Point[] {\r\n        const points = this.periodSegments.map(segment => {\r\n            return {\r\n                x: segment.startingRay.radius * Math.cos(segment.startingRay.angle),\r\n                y: segment.startingRay.radius * Math.sin(segment.startingRay.angle),\r\n            };\r\n        });\r\n        return points;\r\n    }\r\n\r\n    private buildPeriodPointsWithTeeth(idealToothSize: number): Point[] {\r\n        const teethCount = Math.ceil(this.periodSurface / idealToothSize);\r\n        const toothSize = this.periodSurface / teethCount;\r\n\r\n        const points: Point[] = [];\r\n        const stepSize = toothSize / 10;\r\n        let i = 0;\r\n        for (const surfaceFragment of this.walkOnPeriod(stepSize)) {\r\n            const cos = Math.cos(i * TWO_PI / toothSize - Math.PI / 2);\r\n            const teethOffset = idealToothSize / 7 * this.orientation * Math.sign(cos) * Math.pow(Math.abs(cos), 1 / 5);\r\n\r\n            points.push({\r\n                x: surfaceFragment.point.x + teethOffset * surfaceFragment.normal.x,\r\n                y: surfaceFragment.point.y + teethOffset * surfaceFragment.normal.y,\r\n            });\r\n            i += stepSize;\r\n        }\r\n        return points;\r\n    }\r\n\r\n    private buildSvgPath(pointsForPeriod: Point[]): string {\r\n        const pathParts = [\"M\"];\r\n\r\n        for (let iP = 0; iP < this.periodsCount; iP++) {\r\n            const periodStartingAngle = this.orientation * iP * this.periodAngle;\r\n            const cos = Math.cos(periodStartingAngle);\r\n            const sin = Math.sin(periodStartingAngle);\r\n\r\n            for (const point of pointsForPeriod) {\r\n                const x = cos * point.x - sin * point.y;\r\n                const y = sin * point.x + cos * point.y;\r\n                pathParts.push(`${x} ${y}`);\r\n            }\r\n        }\r\n\r\n        pathParts.push(\"Z\");\r\n        return pathParts.join(\" \");\r\n    }\r\n\r\n    private buildSvgRepresentation(): SvgRepresentation {\r\n        const containerElement = document.createElementNS(\"http://www.w3.org/2000/svg\", \"g\");\r\n        containerElement.setAttribute(\"transform\", `translate(${this.center.x},${this.center.y})`);\r\n\r\n        const rotationElement = document.createElementNS(\"http://www.w3.org/2000/svg\", \"g\");\r\n        containerElement.appendChild(rotationElement);\r\n\r\n        const gearElement = document.createElementNS(\"http://www.w3.org/2000/svg\", \"path\");\r\n        gearElement.setAttribute(\"class\", this.parent ? Gear.gearClass : `${Gear.gearClass} ${Gear.gearMainClass}`);\r\n        rotationElement.appendChild(gearElement);\r\n\r\n        const firstPeriodSegment = this.periodSegments[0];\r\n        if (!firstPeriodSegment) {\r\n            throw new Error(\"Gear has no rays.\");\r\n        }\r\n\r\n        // rays\r\n        {\r\n            const length = Math.min(0.75 * firstPeriodSegment.startingRay.radius, 0.05);\r\n\r\n            const pathParts: string[] = [];\r\n            for (let i = 0; i < this.periodsCount; i++) {\r\n                pathParts.push(\"M0 0\");\r\n\r\n                const angle = firstPeriodSegment.startingRay.angle + i * this.periodAngle;\r\n                const x = length * Math.cos(angle);\r\n                const y = length * Math.sin(angle);\r\n                pathParts.push(`L${x} ${y}`);\r\n            }\r\n            const raysElement = document.createElementNS(\"http://www.w3.org/2000/svg\", \"path\");\r\n            raysElement.setAttribute(\"d\", pathParts.join(\"\"));\r\n            raysElement.setAttribute(\"class\", Gear.gearRaysClass);\r\n            rotationElement.appendChild(raysElement);\r\n        }\r\n\r\n        // center\r\n        {\r\n            let centerElement: SVGElement;\r\n            if (this.periodsCount < 3) {\r\n                centerElement = document.createElementNS(\"http://www.w3.org/2000/svg\", \"circle\");\r\n                centerElement.setAttribute(\"cx\", \"0\");\r\n                centerElement.setAttribute(\"cy\", \"0\");\r\n                centerElement.setAttribute(\"r\", Gear.centerRadius.toString());\r\n            } else {\r\n                const radius = Gear.centerRadius * (1 + 0.1 * Math.max(0, 5 - this.periodsCount + 3));\r\n                const pathParts: string[] = [];\r\n                for (let i = 0; i < this.periodsCount; i++) {\r\n                    const command = (i === 0) ? \"M\" : \"L\";\r\n                    const angle = firstPeriodSegment.startingRay.angle + i * this.periodAngle;\r\n                    const x = radius * Math.cos(angle);\r\n                    const y = radius * Math.sin(angle);\r\n                    pathParts.push(`${command}${x} ${y}`);\r\n                }\r\n                pathParts.push(\"Z\");\r\n                centerElement = document.createElementNS(\"http://www.w3.org/2000/svg\", \"path\");\r\n                centerElement.setAttribute(\"d\", pathParts.join(\"\"));\r\n            }\r\n            centerElement.setAttribute(\"class\", Gear.gearAxisClass);\r\n            rotationElement.appendChild(centerElement);\r\n        }\r\n\r\n        return {\r\n            container: containerElement,\r\n            rotationElement,\r\n            gearElement,\r\n            currentSurfaceType: ESurfaceType.NONE,\r\n            computedPaths: {},\r\n        };\r\n    }\r\n}\r\n\r\nexport {\r\n    ESurfaceType,\r\n    Gear,\r\n};\r\n\r\n","import { angleDifference, normalizeAngle, toRadians, TWO_PI } from \"./angle-utils\";\r\nimport { Point } from \"./point\";\r\nimport { Ray } from \"./rays\";\r\n\r\ndeclare const vnoise: {\r\n    seed: number,\r\n    fractal2d: (x: number, y: number, octave: number) => number; // returns something in [-2,+2]\r\n}; // from js-value-noise\r\n\r\ntype PolarCurve = {\r\n    periodRays: Ray[];\r\n    periodsCount: number;\r\n};\r\n\r\n// ax +by = c\r\ntype LineEquation = {\r\n    a: number;\r\n    b: number;\r\n    c: number;\r\n};\r\n\r\ntype CircleEquation = {\r\n    center: Point;\r\n    radius: number;\r\n};\r\n\r\nenum ERadiusChoice {\r\n    NEAREST,\r\n    FURTHEST,\r\n}\r\n\r\nfunction getRadiusForCircle(circleEquation: CircleEquation, angle: number, choice: ERadiusChoice): number {\r\n    const a = -2 * (circleEquation.center.x * Math.cos(angle) + circleEquation.center.y * Math.sin(angle));\r\n    const b = circleEquation.center.x * circleEquation.center.x + circleEquation.center.y * circleEquation.center.y - circleEquation.radius * circleEquation.radius;\r\n\r\n    const det = a * a - 4 * b;\r\n    if (det >= 0) {\r\n        const sqrtDet = Math.sqrt(det);\r\n        if (choice === ERadiusChoice.NEAREST) {\r\n            return 0.5 * (-sqrtDet - a);\r\n        } else {\r\n            return 0.5 * (sqrtDet - a);\r\n        }\r\n\r\n    }\r\n    return NaN;\r\n}\r\n\r\nfunction getLineEquation(p1: Point, p2: Point): LineEquation {\r\n    const a = (p1.y - p2.y) / (p2.x - p1.x);\r\n    const b = 1;\r\n    const c = p1.y + a * p1.x;\r\n    return { a, b, c };\r\n}\r\n\r\nfunction getRadiusForLine(line: LineEquation, angle: number): number {\r\n    const det = line.a * Math.cos(angle) + line.b * Math.sin(angle);\r\n    if (det === 0) {\r\n        return NaN;\r\n    }\r\n    return line.c / det;\r\n}\r\n\r\nfunction buildEllipse(a: number, b: number): PolarCurve {\r\n    const periodsCount = 2;\r\n    const periodStepsCount = 60;\r\n    const periodRays: Ray[] = [];\r\n    for (let i = 0; i < periodStepsCount; i++) {\r\n        const percentage = i / periodStepsCount;\r\n        const angle = Math.PI * percentage;\r\n        periodRays.push({\r\n            angle,\r\n            radius: a * b / Math.sqrt(Math.pow(b * Math.cos(angle), 2) + Math.pow(a * Math.sin(angle), 2)),\r\n        });\r\n    }\r\n\r\n    return {\r\n        periodRays,\r\n        periodsCount,\r\n    };\r\n}\r\n\r\nfunction buildCircle(radius: number): PolarCurve {\r\n    const periodsCount = 3;\r\n    const periodSize = 40;\r\n\r\n    const periodRays: Ray[] = [];\r\n    for (let i = 0; i < periodSize; i++) {\r\n        const percentage = i / periodSize;\r\n        const angle = TWO_PI / periodsCount * percentage;\r\n        periodRays.push({\r\n            angle,\r\n            radius,\r\n        });\r\n    }\r\n\r\n    return {\r\n        periodRays,\r\n        periodsCount,\r\n    };\r\n}\r\n\r\nfunction buildOffCircle(radius: number, centerOffset: number): PolarCurve {\r\n    const center = { x: centerOffset, y: 0 };\r\n    const circleEquation = { center, radius };\r\n\r\n    const periodsCount = 1;\r\n    const raysCount = 120;\r\n\r\n    const periodRays: Ray[] = [];\r\n    for (let i = 0; i < raysCount; i++) {\r\n        const percentage = i / raysCount;\r\n        const angle = TWO_PI * percentage;\r\n\r\n        const localRadius = getRadiusForCircle(circleEquation, angle, ERadiusChoice.FURTHEST);\r\n        if (isNaN(localRadius)) {\r\n            throw new Error();\r\n        }\r\n        periodRays.push({ angle, radius: localRadius });\r\n    }\r\n\r\n    return {\r\n        periodRays,\r\n        periodsCount,\r\n    };\r\n}\r\n\r\nfunction buildHeart(size: number): PolarCurve {\r\n    const periodsCount = 1;\r\n    const raysCount = 90;\r\n\r\n    const lineEquations: LineEquation[] = [];\r\n    lineEquations.push({ a: 1, b: 1, c: -1 });\r\n    lineEquations.push({ a: -1, b: 1, c: 1 });\r\n    lineEquations.push({ a: 1, b: 0, c: 5 });\r\n\r\n    const bottomCircleRadius = 0.2;\r\n    const bottomCircleEquation: CircleEquation = {\r\n        center: { x: -1 + bottomCircleRadius * Math.SQRT2, y: 0 },\r\n        radius: bottomCircleRadius,\r\n    };\r\n\r\n    const lobesRadius = 0.6;\r\n    const lobesX = lobesRadius * Math.SQRT2 - 0.45;\r\n    const lobesY = 0.95 * lobesRadius;\r\n    const lobesSidesX = lobesX - lobesRadius * Math.SQRT2 + 0.4;\r\n    const lobeCirclesEquations: CircleEquation[] = [\r\n        { center: { x: lobesX, y: lobesY }, radius: lobesRadius },\r\n        { center: { x: lobesX, y: -lobesY }, radius: lobesRadius },\r\n    ];\r\n\r\n    const lobesCentralEquation: CircleEquation = {\r\n        center: { x: 1, y: 0 },\r\n        radius: 0.2,\r\n    };\r\n\r\n    const rotation = 0;\r\n    const periodRays: Ray[] = [];\r\n    for (let i = 0; i < raysCount; i++) {\r\n        const percentage = i / raysCount;\r\n        const angle = normalizeAngle(TWO_PI * percentage);\r\n\r\n        let radius = 1000000;\r\n        for (const lineEquation of lineEquations) {\r\n            const localRadius = getRadiusForLine(lineEquation, angle);\r\n            if (!isNaN(localRadius) && localRadius > 0) {\r\n                radius = Math.min(localRadius, radius);\r\n            }\r\n        }\r\n\r\n        {\r\n            const localRadius = getRadiusForCircle(bottomCircleEquation, angle, ERadiusChoice.FURTHEST);\r\n            if (!isNaN(localRadius) && localRadius > 0) {\r\n                const pointX = localRadius * Math.cos(angle);\r\n                if (pointX < 0.5 * (bottomCircleEquation.center.x - 1)) {\r\n                    radius = Math.min(localRadius, radius);\r\n                }\r\n            }\r\n        }\r\n\r\n        {\r\n            for (const lobeCircleEquation of lobeCirclesEquations) {\r\n                const localRadius = getRadiusForCircle(lobeCircleEquation, angle, ERadiusChoice.FURTHEST);\r\n                if (!isNaN(localRadius) && localRadius > 0) {\r\n                    const point = { x: localRadius * Math.cos(angle), y: localRadius * Math.sin(angle) };\r\n                    if (point.y * lobeCircleEquation.center.y >= 0 && point.x > lobesSidesX) {\r\n                        radius = Math.min(localRadius, radius);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        {\r\n            const localRadius = getRadiusForCircle(lobesCentralEquation, angle, ERadiusChoice.NEAREST);\r\n            if (!isNaN(localRadius) && localRadius > 0) {\r\n                const pointX = localRadius * Math.cos(angle);\r\n                if (pointX < 1) {\r\n                    radius = Math.max(localRadius, radius);\r\n                }\r\n            }\r\n        }\r\n\r\n        periodRays.push({\r\n            angle: normalizeAngle(angle - rotation),\r\n            radius: radius * size * 7,\r\n        });\r\n    }\r\n\r\n    periodRays.sort((ray1: Ray, ray2: Ray) => ray1.angle - ray2.angle);\r\n\r\n    return {\r\n        periodRays,\r\n        periodsCount,\r\n    };\r\n}\r\n\r\nfunction buildPolygon(size: number, sides: number): PolarCurve {\r\n    const periodsCount = sides;\r\n    const raysCount = 40;\r\n\r\n    const periodAngle = TWO_PI / sides;\r\n    const p1 = { x: 1, y: 0 };\r\n    const p2 = { x: Math.cos(periodAngle), y: Math.sin(periodAngle) };\r\n    const lineEquation = getLineEquation(p1, p2);\r\n\r\n    const interiorAngle = toRadians(180 * (sides - 2) / sides);\r\n    const circlesRadius = 0.2;\r\n    const circleDistance = 1 - circlesRadius / Math.sin(interiorAngle / 2);\r\n\r\n    const circles: CircleEquation[] = [{\r\n        center: { x: circleDistance, y: 0 },\r\n        radius: circlesRadius\r\n    }, {\r\n        center: { x: circleDistance * Math.cos(periodAngle), y: circleDistance * Math.sin(periodAngle) },\r\n        radius: circlesRadius\r\n    }];\r\n\r\n    const isCircleRadiusValid = (circleEquation: CircleEquation, angle: number, radius: number): boolean => {\r\n        const intersection = { x: radius * Math.cos(angle), y: radius * Math.sin(angle) };\r\n        const circleAngle = Math.atan2(circleEquation.center.y, circleEquation.center.x);\r\n        const localAngle = Math.atan2(intersection.y - circleEquation.center.y, intersection.x - circleEquation.center.x);\r\n        return angleDifference(circleAngle, localAngle) < Math.PI - Math.PI / 2 - 0.5 * interiorAngle;\r\n    };\r\n\r\n    const periodRays: Ray[] = [];\r\n    for (let i = 0; i < raysCount; i++) {\r\n        const angle = i / raysCount * periodAngle;\r\n\r\n        let radius = getRadiusForLine(lineEquation, angle);\r\n        for (const circle of circles) {\r\n            const circleRadius = getRadiusForCircle(circle, angle, ERadiusChoice.FURTHEST);\r\n            if (!isNaN(circleRadius)) {\r\n                if (isCircleRadiusValid(circle, angle, circleRadius)) {\r\n                    radius = Math.min(circleRadius, circleRadius);\r\n                }\r\n            }\r\n        }\r\n        periodRays.push({ angle, radius: size * radius });\r\n    }\r\n\r\n    return {\r\n        periodRays,\r\n        periodsCount,\r\n    };\r\n}\r\n\r\nfunction buildOffPolygon(size: number, sides: number, offset: number): PolarCurve {\r\n    const periodsCount = 1;\r\n    const raysCount = 90;\r\n\r\n    const interiorAngle = toRadians(180 * (sides - 2) / sides);\r\n    const circlesRadius = 0.2;\r\n    const circleDistance = 1 - circlesRadius / Math.sin(interiorAngle / 2);\r\n    const circles: CircleEquation[] = [];\r\n\r\n    const periodAngle = TWO_PI / sides;\r\n    const center = { x: offset, y: 0 };\r\n    const points: Point[] = [];\r\n    for (let i = 0; i < sides; i++) {\r\n        const angle = i * periodAngle;\r\n        points.push({\r\n            x: Math.cos(angle) - center.x,\r\n            y: Math.sin(angle) - center.y,\r\n        });\r\n\r\n        circles.push({\r\n            center: { x: -center.x + circleDistance * Math.cos(angle), y: -center.y + circleDistance * Math.sin(angle) },\r\n            radius: circlesRadius,\r\n        });\r\n    }\r\n\r\n    const isCircleRadiusValid = (circleEquation: CircleEquation, angle: number, radius: number): boolean => {\r\n        const intersection = { x: center.x + radius * Math.cos(angle), y: center.y + radius * Math.sin(angle) };\r\n        const realCenter = { x: circleEquation.center.x + center.x, y: circleEquation.center.y + center.y };\r\n        const circleAngle = Math.atan2(realCenter.y, realCenter.x);\r\n        const localAngle = Math.atan2(intersection.y - realCenter.y, intersection.x - realCenter.x);\r\n        return angleDifference(circleAngle, localAngle) < Math.PI - Math.PI / 2 - 0.5 * interiorAngle;\r\n    };\r\n\r\n    const lineEquations = points.map((point: Point, index: number) => {\r\n        const p1 = point;\r\n        const p2 = points[(index + 1) % points.length]!;\r\n        return getLineEquation(p1, p2);\r\n    });\r\n\r\n    const periodRays: Ray[] = [];\r\n    for (let i = 0; i < raysCount; i++) {\r\n        const angle = i / raysCount * TWO_PI;\r\n\r\n        let minRadius = 100000;\r\n        for (const lineEquation of lineEquations) {\r\n            const radius = getRadiusForLine(lineEquation, angle);\r\n            if (radius > 0 && radius < minRadius) {\r\n                minRadius = radius;\r\n            }\r\n        }\r\n\r\n        for (const circle of circles) {\r\n            const circleRadius = getRadiusForCircle(circle, angle, ERadiusChoice.FURTHEST);\r\n            if (!isNaN(circleRadius)) {\r\n                if (circleRadius > 0 && isCircleRadiusValid(circle, angle, circleRadius)) {\r\n                    minRadius = Math.min(circleRadius, circleRadius);\r\n                }\r\n            }\r\n        }\r\n\r\n        periodRays.push({ angle, radius: size * minRadius });\r\n    }\r\n\r\n    return {\r\n        periodRays,\r\n        periodsCount,\r\n    };\r\n}\r\n\r\nfunction buildRandom(size: number): PolarCurve {\r\n    const periodsCount = 1;\r\n    const raysCount = 90;\r\n\r\n    const range = size * 1.5;\r\n\r\n    vnoise.seed = Math.random();\r\n\r\n    const periodRays: Ray[] = [];\r\n    for (let i = 0; i < raysCount; i++) {\r\n        const angle = TWO_PI * i / raysCount;\r\n        const noise = vnoise.fractal2d(Math.cos(angle), Math.sin(angle), 2) * 0.25; // in [-0.5,+0.5]\r\n        periodRays.push({\r\n            angle,\r\n            radius: size + range * noise,\r\n        });\r\n    }\r\n\r\n    return {\r\n        periodRays,\r\n        periodsCount,\r\n    };\r\n}\r\n\r\nexport type {\r\n    PolarCurve,\r\n};\r\nexport {\r\n    buildCircle,\r\n    buildEllipse,\r\n    buildHeart,\r\n    buildOffCircle,\r\n    buildOffPolygon,\r\n    buildPolygon,\r\n    buildRandom,\r\n};\r\n\r\n","import { angleDifference } from \"./angle-utils\";\r\nimport type { Point, Vector } from \"./point\";\r\n\r\ntype Ray = {\r\n    angle: number;\r\n    radius: number;\r\n};\r\n\r\ntype ReadonlyRay = {\r\n    readonly angle: number;\r\n    readonly radius: number;\r\n};\r\n\r\nfunction computeRayPoint(ray: Ray): Point {\r\n    return {\r\n        x: ray.radius * Math.cos(ray.angle),\r\n        y: ray.radius * Math.sin(ray.angle),\r\n    };\r\n}\r\n\r\nfunction computeDeltaAngle(ray1: Ray, ray2: Ray): number {\r\n    return angleDifference(ray1.angle, ray2.angle);\r\n}\r\n\r\nfunction computeDistanceSquared(ray1: Ray, ray2: Ray): number {\r\n    const deltaAngle = computeDeltaAngle(ray1, ray2);\r\n    return (ray1.radius * ray1.radius) + (ray2.radius * ray2.radius) - 2 * ray1.radius * ray2.radius * Math.cos(deltaAngle);\r\n}\r\n\r\nfunction computeDistance(ray1: Ray, ray2: Ray): number {\r\n    return Math.sqrt(computeDistanceSquared(ray1, ray2));\r\n}\r\n\r\nfunction computeNormal(ray1: Ray, ray2: Ray): Vector {\r\n    const point1 = computeRayPoint(ray1);\r\n    const point2 = computeRayPoint(ray2);\r\n\r\n    const normal = {\r\n        x: -(point2.y - point1.y),\r\n        y: point2.x - point1.x,\r\n    };\r\n    const length = Math.sqrt(normal.x * normal.x + normal.y * normal.y);\r\n    normal.x /= length;\r\n    normal.y /= length;\r\n\r\n    if (point1.x * normal.x + point1.y * normal.y < 0) {\r\n        normal.x *= -1;\r\n        normal.y *= -1;\r\n    }\r\n    return normal;\r\n}\r\n\r\nexport type {\r\n    Ray,\r\n    ReadonlyRay,\r\n};\r\nexport {\r\n    computeDeltaAngle,\r\n    computeDistance,\r\n    computeDistanceSquared,\r\n    computeNormal,\r\n};\r\n\r\n\r\n","/// <reference types=\"./page-interface-generated\" />\r\n\r\nconst controlId = {\r\n    CENTRAL_GEAR_SELECT_ID: \"central-gear-select-id\",\r\n    SHIFT_CENTER_CHECKBOX_ID: \"shift-center-checkbox-id\",\r\n    ROTATION_SPEED_RANGE: \"rotation-speed-range-id\",\r\n    RESET_BUTTON_ID: \"reset-button\",\r\n    RANDOM_BUTTON_ID: \"random-button\",\r\n    DISPLAY_STYLE_TABS_ID: \"display-style-tabs-id\",\r\n    SHOW_RAYS_CHECKBOX_ID: \"show-rays-checkbox-id\",\r\n    SHOW_TEETH_CHECKBOX_ID: \"show-teeth-checkbox-id\",\r\n    TEETH_SIZE_TABS_ID: \"teeth-size-tabs-id\",\r\n    DOWNLOAD_BUTTON_ID: \"download-button\",\r\n};\r\n\r\nenum EGearShape {\r\n    ELLIPSE = \"ellipse\",\r\n    HEART = \"heart\",\r\n    TRIANGLE = \"triangle\",\r\n    SQUARE = \"square\",\r\n    PENTAGON = \"pentagon\",\r\n    RANDOM = \"random\",\r\n    CIRCLE = \"circle\",\r\n    OFF_CIRCLE = \"off-circle\",\r\n    OFF_TRIANGLE = \"off-triangle\",\r\n    OFF_SQUARE = \"off-square\",\r\n    OFF_PENTAGON = \"off-pentagon\",\r\n}\r\n\r\nenum EDisplayStyle {\r\n    FLAT = \"flat\",\r\n    OUTLINE = \"outline\",\r\n}\r\n\r\nenum ETeethSize {\r\n    SMALL = \"small\",\r\n    MEDIUM = \"medium\",\r\n    LARGE = \"large\",\r\n}\r\n\r\nfunction callCallbacks(callbacks: VoidFunction[]): void {\r\n    for (const callback of callbacks) {\r\n        callback();\r\n    }\r\n}\r\n\r\nPage.Select.addObserver(controlId.CENTRAL_GEAR_SELECT_ID, () => {\r\n    callCallbacks(Parameters.onGearShapeChange);\r\n});\r\nPage.Checkbox.addObserver(controlId.SHIFT_CENTER_CHECKBOX_ID, () => {\r\n    callCallbacks(Parameters.onGearShapeChange);\r\n});\r\n\r\nPage.Button.addObserver(controlId.RESET_BUTTON_ID, () => {\r\n    callCallbacks(Parameters.onReset);\r\n});\r\n\r\nPage.Button.addObserver(controlId.DOWNLOAD_BUTTON_ID, () => {\r\n    callCallbacks(Parameters.onDownload);\r\n});\r\n\r\nPage.Button.addObserver(controlId.RANDOM_BUTTON_ID, () => {\r\n    const gearShapes = Object.values(EGearShape);\r\n    const shapeId = Math.floor(Math.random() * gearShapes.length);\r\n    const gearShape = gearShapes[shapeId] as string;\r\n    Page.Select.setValue(controlId.CENTRAL_GEAR_SELECT_ID, gearShape);\r\n    updateShiftCenterControl();\r\n    Page.Checkbox.setChecked(controlId.SHIFT_CENTER_CHECKBOX_ID, Math.random() > 0.5);\r\n    callCallbacks(Parameters.onReset);\r\n});\r\n\r\nfunction onDisplayStyleChange(): void {\r\n    callCallbacks(Parameters.onDisplayStyleChange);\r\n}\r\nPage.Tabs.addObserver(controlId.DISPLAY_STYLE_TABS_ID, onDisplayStyleChange);\r\nPage.Checkbox.addObserver(controlId.SHOW_RAYS_CHECKBOX_ID, onDisplayStyleChange);\r\n\r\nabstract class Parameters {\r\n    public static get rotationSpeed(): number {\r\n        return Page.Range.getValue(controlId.ROTATION_SPEED_RANGE);\r\n    }\r\n\r\n    public static get gearShape(): EGearShape {\r\n        const gearShape = Page.Select.getValue(controlId.CENTRAL_GEAR_SELECT_ID) as EGearShape;\r\n        if (Parameters.shiftCenter) {\r\n            if (gearShape === EGearShape.CIRCLE) {\r\n                return EGearShape.OFF_CIRCLE;\r\n            } else if (gearShape === EGearShape.TRIANGLE) {\r\n                return EGearShape.OFF_TRIANGLE;\r\n            } else if (gearShape === EGearShape.SQUARE) {\r\n                return EGearShape.OFF_SQUARE;\r\n            } else if (gearShape === EGearShape.PENTAGON) {\r\n                return EGearShape.OFF_PENTAGON;\r\n            }\r\n        }\r\n        return gearShape;\r\n    }\r\n\r\n    public static get displayStyle(): EDisplayStyle {\r\n        return Page.Tabs.getValues(controlId.DISPLAY_STYLE_TABS_ID)[0] as EDisplayStyle;\r\n    }\r\n    public static get showRays(): boolean {\r\n        return Page.Checkbox.isChecked(controlId.SHOW_RAYS_CHECKBOX_ID);\r\n    }\r\n\r\n    public static get showTeeth(): boolean {\r\n        return Page.Checkbox.isChecked(controlId.SHOW_TEETH_CHECKBOX_ID);\r\n    }\r\n\r\n    public static get teethSize(): ETeethSize {\r\n        return Page.Tabs.getValues(controlId.TEETH_SIZE_TABS_ID)[0] as ETeethSize;\r\n    }\r\n\r\n    private static get shiftCenter(): boolean {\r\n        return Page.Checkbox.isChecked(controlId.SHIFT_CENTER_CHECKBOX_ID);\r\n    }\r\n\r\n    public static onGearShapeChange: VoidFunction[] = [];\r\n\r\n    public static onReset: VoidFunction[] = [];\r\n\r\n    public static onDownload: VoidFunction[] = [];\r\n\r\n    public static onDisplayStyleChange: VoidFunction[] = [];\r\n}\r\n\r\nfunction updateTeethSizeControls(): void {\r\n    Page.Controls.setVisibility(controlId.TEETH_SIZE_TABS_ID, Parameters.showTeeth);\r\n}\r\nPage.Checkbox.addObserver(controlId.SHOW_TEETH_CHECKBOX_ID, updateTeethSizeControls);\r\nupdateTeethSizeControls();\r\n\r\nfunction updateShiftCenterControl(): void {\r\n    const gearShape = Page.Select.getValue(controlId.CENTRAL_GEAR_SELECT_ID) as EGearShape;\r\n    const visible = [EGearShape.CIRCLE, EGearShape.TRIANGLE, EGearShape.SQUARE, EGearShape.PENTAGON].includes(gearShape);\r\n    Page.Controls.setVisibility(controlId.SHIFT_CENTER_CHECKBOX_ID, visible);\r\n}\r\nPage.Select.addObserver(controlId.CENTRAL_GEAR_SELECT_ID, updateShiftCenterControl);\r\nupdateShiftCenterControl();\r\n\r\nexport {\r\n    EDisplayStyle,\r\n    EGearShape,\r\n    ETeethSize,\r\n    Parameters,\r\n};\r\n\r\n","import { Gear } from \"../engine/gear\";\r\nimport type { PolarCurve } from \"../engine/polar-curves\";\r\nimport * as PolarCurves from \"../engine/polar-curves\";\r\nimport { EGearShape } from \"../parameters\";\r\nimport { SvgCanvas } from \"../svg-canvas\";\r\nimport { distance } from \"../utils\";\r\nimport { Scene } from \"./scene\";\r\n\r\nfunction rand(min: number, max: number): number {\r\n    return min + (max - min) * Math.random();\r\n}\r\n\r\nclass RandomScene extends Scene {\r\n    public static create(svgCanvas: SvgCanvas, centralGear: EGearShape): RandomScene {\r\n        let bestScene = new RandomScene(svgCanvas, centralGear);\r\n\r\n        for (let i = 0; i < 5; i++) {\r\n            const scene = new RandomScene(svgCanvas, centralGear);\r\n            if (scene.secondaryGears.length > bestScene.secondaryGears.length) {\r\n                bestScene = scene;\r\n            }\r\n        }\r\n\r\n        return bestScene;\r\n    }\r\n\r\n    private constructor(svgCanvas: SvgCanvas, centralGear: EGearShape) {\r\n        const size = 0.1;\r\n\r\n        let polarCurve: PolarCurve;\r\n        switch (centralGear) {\r\n            case EGearShape.ELLIPSE:\r\n                polarCurve = PolarCurves.buildEllipse(size, rand(0.4, 0.7) * size);\r\n                break;\r\n            case EGearShape.HEART:\r\n                polarCurve = PolarCurves.buildHeart(0.17 * size);\r\n                break;\r\n            case EGearShape.OFF_CIRCLE:\r\n                polarCurve = PolarCurves.buildOffCircle(size, rand(0.3, 0.9) * size);\r\n                break;\r\n            case EGearShape.TRIANGLE:\r\n                polarCurve = PolarCurves.buildPolygon(size, 3);\r\n                break;\r\n            case EGearShape.SQUARE:\r\n                polarCurve = PolarCurves.buildPolygon(size, 4);\r\n                break;\r\n            case EGearShape.PENTAGON:\r\n                polarCurve = PolarCurves.buildPolygon(size, 5);\r\n                break;\r\n            case EGearShape.OFF_TRIANGLE:\r\n                polarCurve = PolarCurves.buildOffPolygon(size, 3, rand(0.3, 0.5));\r\n                break;\r\n            case EGearShape.OFF_SQUARE:\r\n                polarCurve = PolarCurves.buildOffPolygon(size, 4, rand(0.3, 0.5));\r\n                break;\r\n            case EGearShape.OFF_PENTAGON:\r\n                polarCurve = PolarCurves.buildOffPolygon(size, 5, rand(0.3, 0.5));\r\n                break;\r\n            case EGearShape.CIRCLE:\r\n                polarCurve = PolarCurves.buildCircle(size);\r\n                break;\r\n            case EGearShape.RANDOM:\r\n                polarCurve = PolarCurves.buildRandom(size);\r\n                break;\r\n            default:\r\n                throw new Error(centralGear);\r\n        }\r\n\r\n        const mainGear = Gear.create({ x: 0, y: 0 }, polarCurve);\r\n\r\n        super(svgCanvas, mainGear);\r\n\r\n        this.secondaryGears = [];\r\n\r\n        const viewportWidth = svgCanvas.width;\r\n        const viewportHeight = svgCanvas.height;\r\n        for (let i = 0; i < 300; i++) {\r\n            const center = {\r\n                x: rand(-0.5 * viewportWidth, 0.5 * viewportWidth),\r\n                y: rand(-0.5 * viewportHeight, 0.5 * viewportHeight),\r\n            };\r\n            const isInsideGear = !!this.allGears.find(existingGear => distance(center, existingGear.center) < existingGear.minRadius);\r\n            if (isInsideGear) {\r\n                continue;\r\n            }\r\n\r\n            const newGear = this.tryBuildGear(center);\r\n            if (newGear && newGear.minRadius > 1.2 * Gear.centerRadius && newGear.maxRadius < 0.3) {\r\n                this.secondaryGears.push(newGear);\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nexport {\r\n    RandomScene,\r\n};\r\n\r\n","/// <reference types=\"../page-interface-generated\" />\r\n\r\nimport { ESurfaceType, Gear } from \"../engine/gear\";\r\nimport { Point } from \"../engine/point\";\r\nimport { EDisplayStyle, ETeethSize, Parameters } from \"../parameters\";\r\nimport { SvgCanvas } from \"../svg-canvas\";\r\nimport { distance } from \"../utils\";\r\n\r\nfunction removeFromArray<T>(array: T[], element: T): void {\r\n    while (array.length > 0) {\r\n        const index = array.indexOf(element);\r\n        if (index < 0) {\r\n            return;\r\n        }\r\n        array.splice(index, 1);\r\n    }\r\n}\r\n\r\nabstract class Scene {\r\n    protected readonly mainGear: Gear;\r\n    protected secondaryGears: Gear[] = [];\r\n\r\n    private readonly svgCanvas: SvgCanvas;\r\n\r\n    private readonly onMouseMove: VoidFunction;\r\n    private readonly onMouseUp: VoidFunction;\r\n    private readonly onMouseUpRight: (event: MouseEvent) => void;\r\n\r\n    private mobileGear: Gear | null = null;\r\n\r\n    protected constructor(svgCanvas: SvgCanvas, mainGear: Gear) {\r\n        this.svgCanvas = svgCanvas;\r\n\r\n        const updateStyle = (): void => {\r\n            const flatStyle = (Parameters.displayStyle === EDisplayStyle.FLAT);\r\n            const gearColor = \"red\";\r\n            const gearMainColor = \"#FF6A00\";\r\n            const axisColor = flatStyle ? \"#333333\" : \"green\";\r\n\r\n            const newStyle = `.${Gear.gearClass} {\r\n    fill:           ${gearColor};\r\n    fill-opacity:   ${flatStyle ? 0.7 : 0.4};\r\n    stroke:         ${gearColor};\r\n    stroke-width:   ${flatStyle ? 0 : 0.004};\r\n}\r\n.${Gear.gearClass}.${Gear.gearMainClass} {\r\n    fill:   ${gearMainColor};\r\n    stroke: ${gearMainColor};\r\n}\r\n.${Gear.gearRaysClass} {\r\n    ${Parameters.showRays ? \"\" : \"display: none;\"}\r\n    stroke:         ${axisColor};\r\n    stroke-width:   0.006;\r\n}\r\n.${Gear.gearAxisClass} {\r\n    fill: ${axisColor};\r\n}`;\r\n            this.svgCanvas.setStyle(newStyle);\r\n        };\r\n        Parameters.onDisplayStyleChange.push(updateStyle);\r\n        updateStyle();\r\n\r\n        this.mainGear = mainGear;\r\n\r\n        this.onMouseMove = () => {\r\n            const center = this.getMousePosition();\r\n\r\n            if (this.mobileGear) {\r\n                this.svgCanvas.removeChild(this.mobileGear.svgElement);\r\n                this.mobileGear = null;\r\n            }\r\n\r\n            const hoveredGear = this.getHoveredGear();\r\n            if (!hoveredGear) {\r\n                this.mobileGear = this.tryBuildGear(center);\r\n                if (this.mobileGear) {\r\n                    this.svgCanvas.addChild(this.mobileGear.svgElement);\r\n                }\r\n            }\r\n\r\n            this.svgCanvas.cursor = (this.mobileGear || hoveredGear) ? \"\" : \"not-allowed\";\r\n        };\r\n\r\n        this.onMouseUp = () => {\r\n            if (this.mobileGear) {\r\n                this.secondaryGears.push(this.mobileGear);\r\n                this.mobileGear = null;\r\n            }\r\n        };\r\n        this.onMouseUpRight = (event: MouseEvent) => {\r\n            if (event.button === 2) { // right button\r\n                const hoveredGear = this.getHoveredGear();\r\n                if (hoveredGear) {\r\n                    const newSecondaryGears: Gear[] = [];\r\n                    for (const gear of this.secondaryGears) {\r\n                        if (gear.isChildOf(hoveredGear)) {\r\n                            this.svgCanvas.removeChild(gear.svgElement);\r\n                        } else {\r\n                            newSecondaryGears.push(gear);\r\n                        }\r\n                    }\r\n                    this.secondaryGears = newSecondaryGears;\r\n                    this.onMouseMove();\r\n                }\r\n            }\r\n        };\r\n    }\r\n\r\n    public update(dt: number): void {\r\n        this.mainGear.rotate(5 * dt * Parameters.rotationSpeed / 1000);\r\n\r\n        for (const secondaryGear of this.secondaryGears) {\r\n            secondaryGear.update();\r\n        }\r\n\r\n        this.mobileGear?.update();\r\n\r\n        this.updateDisplay();\r\n    }\r\n\r\n    public attach(): void {\r\n        this.detach();\r\n\r\n        Page.Canvas.Observers.mouseMove.push(this.onMouseMove);\r\n        Page.Canvas.Observers.mouseUp.push(this.onMouseUp);\r\n        this.svgCanvas.onMouseUp.push(this.onMouseUpRight);\r\n\r\n        for (const gear of [this.mainGear, ...this.secondaryGears]) {\r\n            this.svgCanvas.addChild(gear.svgElement);\r\n        }\r\n    }\r\n\r\n    public detach(): void {\r\n        removeFromArray(Page.Canvas.Observers.mouseMove, this.onMouseMove);\r\n        removeFromArray(Page.Canvas.Observers.mouseUp, this.onMouseUp);\r\n        removeFromArray(this.svgCanvas.onMouseUp, this.onMouseUpRight);\r\n    }\r\n\r\n    protected tryBuildGear(center: Point): Gear | null {\r\n        const closestGear = this.findClosestGear(center);\r\n\r\n        let newGear: Gear | null = null;\r\n        try {\r\n            newGear = Gear.slaveGear(center, closestGear);\r\n        } catch (e: unknown) {\r\n            console.debug(e);\r\n        }\r\n\r\n        if (newGear) {\r\n            for (const existingGear of this.allGears) {\r\n                if (existingGear !== closestGear) {\r\n                    const margin = distance(newGear.center, existingGear.center) - newGear.maxRadius - existingGear.maxRadius;\r\n                    if (margin <= 0) {\r\n                        return null;\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        return newGear;\r\n    }\r\n\r\n    protected get allGears(): Gear[] {\r\n        return [this.mainGear, ...this.secondaryGears];\r\n    }\r\n\r\n    private updateDisplay(): void {\r\n        const showTeeth = Parameters.showTeeth;\r\n        const teethSize = Parameters.teethSize;\r\n        let surfaceType: ESurfaceType;\r\n        if (showTeeth) {\r\n            if (teethSize === ETeethSize.SMALL) {\r\n                surfaceType = ESurfaceType.TEETH_SMALL;\r\n            } else if (teethSize === ETeethSize.MEDIUM) {\r\n                surfaceType = ESurfaceType.TEETH_MEDIUM;\r\n            } else {\r\n                surfaceType = ESurfaceType.TEETH_LARGE;\r\n            }\r\n        } else {\r\n            surfaceType = ESurfaceType.SMOOTH;\r\n        }\r\n\r\n        for (const gear of this.allGears) {\r\n            gear.updateDisplay(surfaceType);\r\n        }\r\n        this.mobileGear?.updateDisplay(surfaceType);\r\n\r\n        const hoveredGear = this.getHoveredGear();\r\n        const hoveredOpacity = (0.6 + 0.3 * (0.5 + 0.5 * Math.cos(performance.now() / 150))).toFixed(2);\r\n        for (const gear of this.secondaryGears) {\r\n            if (hoveredGear && gear.isChildOf(hoveredGear)) {\r\n                gear.svgElement.style.opacity = hoveredOpacity;\r\n            } else {\r\n                gear.svgElement.style.opacity = \"\";\r\n            }\r\n        }\r\n    }\r\n\r\n    private getHoveredGear(): Gear | null {\r\n        if (!this.mobileGear) {\r\n            const mousePosition = this.getMousePosition();\r\n            return this.secondaryGears.find(gear => gear.isPointInside(mousePosition)) || null;\r\n        }\r\n        return null;\r\n    }\r\n\r\n    private findClosestGear(center: Point): Gear {\r\n        let closestGear = this.mainGear;\r\n        let lowestDistance = distance(center, closestGear.center) - closestGear.maxRadius;\r\n\r\n        for (const gear of this.secondaryGears) {\r\n            const currentDistance = distance(center, gear.center) - gear.maxRadius;\r\n            if (currentDistance < lowestDistance) {\r\n                closestGear = gear;\r\n                lowestDistance = currentDistance;\r\n            }\r\n        }\r\n\r\n        return closestGear;\r\n    }\r\n\r\n    private getMousePosition(): Point {\r\n        const aspectRatio = Page.Canvas.getAspectRatio();\r\n        const mousePosition = Page.Canvas.getMousePosition();\r\n        return {\r\n            x: (2 * mousePosition[0] - 1) * Math.max(1, aspectRatio),\r\n            y: (2 * mousePosition[1] - 1) * Math.max(1, 1 / aspectRatio),\r\n        };\r\n    }\r\n}\r\n\r\nexport {\r\n    Scene\r\n};\r\n\r\n","/// <reference types=\"./page-interface-generated\" />\r\n\r\nimport { downloadTextFile } from \"./utils\";\r\n\r\ntype OnMouseUp = (event: MouseEvent) => void;\r\n\r\nclass SvgCanvas {\r\n    private readonly svg: SVGSVGElement;\r\n    private readonly styleElement: SVGStyleElement;\r\n    private readonly backgroundElement: SVGElement;\r\n    private readonly canvasContainer: HTMLElement;\r\n\r\n    public onMouseUp: OnMouseUp[] = [];\r\n\r\n    public constructor() {\r\n        this.svg = document.createElementNS(\"http://www.w3.org/2000/svg\", \"svg\");\r\n        this.svg.style.position = \"absolute\";\r\n        this.svg.style.top = \"0\";\r\n        this.svg.style.left = \"0\";\r\n        this.svg.style.width = \"100%\";\r\n        this.svg.style.height = \"100%\";\r\n        this.svg.style.pointerEvents = \"none\";\r\n\r\n        this.styleElement = document.createElementNS(\"http://www.w3.org/2000/svg\", \"style\");\r\n        this.svg.appendChild(this.styleElement);\r\n\r\n        this.backgroundElement = document.createElementNS(\"http://www.w3.org/2000/svg\", \"rect\");\r\n        this.backgroundElement.setAttribute(\"x\", \"-100%\");\r\n        this.backgroundElement.setAttribute(\"y\", \"-100%\");\r\n        this.backgroundElement.setAttribute(\"width\", \"200%\");\r\n        this.backgroundElement.setAttribute(\"height\", \"200%\");\r\n        this.backgroundElement.setAttribute(\"fill\", \"black\");\r\n        this.svg.appendChild(this.backgroundElement);\r\n\r\n        const adjustAspectRatio = (): void => {\r\n            const width = this.width;\r\n            const height = this.height;\r\n            this.svg.setAttribute(\"viewBox\", `${-0.5 * width} ${-0.5 * height} ${width} ${height}`);\r\n        };\r\n        Page.Canvas.Observers.canvasResize.push(adjustAspectRatio);\r\n        adjustAspectRatio();\r\n\r\n        const canvasContainer = Page.Canvas.getCanvasContainer();\r\n        if (!canvasContainer) {\r\n            throw new Error();\r\n        }\r\n        this.canvasContainer = canvasContainer;\r\n        this.canvasContainer.insertBefore(this.svg, Page.Canvas.getCanvas());\r\n        this.canvasContainer.addEventListener(\"mouseup\", (event: MouseEvent) => {\r\n            for (const observer of this.onMouseUp) {\r\n                observer(event);\r\n            }\r\n        });\r\n        this.canvasContainer.addEventListener(\"contextmenu\", (event: Event) => {\r\n            event.preventDefault();\r\n        });\r\n    }\r\n\r\n    public clear(): void {\r\n        let child = this.svg.firstChild;\r\n        while (child) {\r\n            this.svg.removeChild(child);\r\n            child = this.svg.firstChild;\r\n        }\r\n        this.svg.appendChild(this.styleElement);\r\n        this.svg.appendChild(this.backgroundElement);\r\n    }\r\n\r\n    public removeChild(child: SVGElement): void {\r\n        this.svg.removeChild(child);\r\n    }\r\n\r\n    public addChild(element: SVGElement): void {\r\n        this.svg.appendChild(element);\r\n    }\r\n\r\n    public download(): void {\r\n        this.svg.setAttribute(\"xmlns\", \"http://www.w3.org/2000/svg\");\r\n        this.svg.setAttribute(\"version\", \"1.1\");\r\n        const content = `<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?>\\n${this.svg.outerHTML}`;\r\n        this.svg.removeAttribute(\"xmlns\");\r\n        this.svg.removeAttribute(\"version\");\r\n\r\n        downloadTextFile(\"gears.svg\", content);\r\n    }\r\n\r\n    public setStyle(style: string): void {\r\n        this.styleElement.innerHTML = style;\r\n    }\r\n\r\n    public get width(): number {\r\n        return 2 * Math.max(1, Page.Canvas.getAspectRatio());\r\n    }\r\n\r\n    public get height(): number {\r\n        return 2 * Math.max(1, 1 / Page.Canvas.getAspectRatio());\r\n    }\r\n\r\n    public set cursor(cursor: string) {\r\n        this.canvasContainer.style.cursor = cursor;\r\n    }\r\n}\r\n\r\nexport {\r\n    SvgCanvas,\r\n};\r\n\r\n","import { Point } from \"./engine/point\";\r\n\r\nfunction distanceSquared(p1: Point, p2: Point): number {\r\n    const dX = p1.x - p2.x;\r\n    const dY = p1.y - p2.y;\r\n    return dX * dX + dY * dY;\r\n}\r\n\r\nfunction distance(p1: Point, p2: Point): number {\r\n    const squared = distanceSquared(p1, p2);\r\n    return Math.sqrt(squared);\r\n}\r\n\r\nfunction downloadTextFile(fileName: string, content: string): void {\r\n    const fileType = \"text/plain\";\r\n\r\n    const blob = new Blob([content], { type: fileType });\r\n\r\n    type IeNavigator = Navigator & {\r\n        msSaveBlob: (blob: Blob, filename: string) => void;\r\n    };\r\n    if (typeof window.navigator !== \"undefined\" && typeof (window.navigator as IeNavigator).msSaveBlob !== \"undefined\") { // for IE\r\n        (window.navigator as IeNavigator).msSaveBlob(blob, fileName);\r\n    } else {\r\n        const objectUrl = URL.createObjectURL(blob);\r\n\r\n        const linkElement = document.createElement('a');\r\n        linkElement.download = fileName;\r\n        linkElement.href = objectUrl;\r\n        linkElement.dataset[\"downloadurl\"] = `${fileType}:${linkElement.download}:${linkElement.href}`;\r\n        linkElement.style.display = \"none\";\r\n        document.body.appendChild(linkElement);\r\n        linkElement.click();\r\n        document.body.removeChild(linkElement);\r\n\r\n        // don't forget to free the objectURL after a few seconds\r\n        setTimeout(() => {\r\n            URL.revokeObjectURL(objectUrl);\r\n        }, 5000);\r\n    }\r\n}\r\n\r\nexport {\r\n    distance,\r\n    distanceSquared,\r\n    downloadTextFile,\r\n};\r\n\r\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","/// <reference types=\"./page-interface-generated\" />\r\n\r\nimport { Parameters } from \"./parameters\";\r\nimport { RandomScene } from \"./scenes/random-scene\";\r\nimport { SvgCanvas } from \"./svg-canvas\";\r\n\r\n\r\nfunction main(): void {\r\n    const svgCanvas = new SvgCanvas();\r\n\r\n    let scene = RandomScene.create(svgCanvas, Parameters.gearShape);\r\n    scene.attach();\r\n\r\n    function resetScene(): void {\r\n        scene.detach();\r\n        svgCanvas.clear();\r\n        scene = RandomScene.create(svgCanvas, Parameters.gearShape);\r\n        scene.attach();\r\n    }\r\n    Parameters.onGearShapeChange.push(resetScene);\r\n    Parameters.onReset.push(resetScene);\r\n    Parameters.onDownload.push(() => svgCanvas.download());\r\n\r\n    let lastUpdate = performance.now();\r\n    function mainLoop(): void {\r\n        const now = performance.now();\r\n        const dt = now - lastUpdate;\r\n        lastUpdate = now;\r\n\r\n        scene.update(dt);\r\n        requestAnimationFrame(mainLoop);\r\n    }\r\n\r\n    requestAnimationFrame(mainLoop);\r\n}\r\n\r\nmain();\r\n"],"names":["TWO_PI","Math","PI","makeAnglePositive","angle","ceil","normalizeAngle","toDegrees","angleInRadians","toRadians","angleInDegrees","angleDifference","angle1","angle2","rawDifference","ESurfaceType","Gear","static","center","polarCurve","periodRays","periodsCount","idealCenter","master","dX","x","dY","y","idealDistance","max","maxRadius","sqrt","adjustedDistance","getNextFittingDistance","period","tryBuildCompanionPeriod","atan2","cos","sin","targetPeriod","orientation","distance","periodSegment","periodSegments","push","radius","startingRay","dSegmentLengthSquared","deltaDistance","r1","r2","nextRay","dAngle","acos","isNaN","Error","periodRay","error","tooLowTry","tooHighTry","triesCount","currentDistance","currentTry","svgElement","this","svgRepresentation","container","parent","rotation","minRadius","forEach","ray","min","periodAngle","firstPeriodRay","map","currentRay","index","deltaAngle","computeDeltaAngle","computeDistance","periodSegmentsReverse","slice","reverse","periodSurface","segment","buildSvgRepresentation","rotate","setRotationInternal","update","previousMasterAngle","relativeRotation","surfaceRotation","getCurrentRotatedSurface","rotateFromSurface","updateDisplay","surfaceType","rotationElement","setAttribute","currentSurfaceType","TEETH_SMALL","TEETH_MEDIUM","TEETH_LARGE","includes","path","computedPaths","idealToothSize","periodPoints","buildPeriodPointsWithTeeth","buildSvgPath","gearElement","SMOOTH","buildPeriodPointsSmooth","isPointInside","position","isChildOf","otherGear","current","nbPeriods","floor","cumulatedAngle","cumulatedSurface","nextCumulatedAngle","nextCumulatedSurface","partial","targetSurface","stepSize","positionOnSegment","normal","computeNormal","point","teethCount","toothSize","points","i","surfaceFragment","walkOnPeriod","teethOffset","sign","pow","abs","pointsForPeriod","pathParts","iP","periodStartingAngle","join","containerElement","document","createElementNS","appendChild","gearClass","gearMainClass","firstPeriodSegment","length","raysElement","gearRaysClass","centerElement","centerRadius","toString","command","gearAxisClass","NONE","ERadiusChoice","getRadiusForCircle","circleEquation","choice","a","det","sqrtDet","NEAREST","NaN","getLineEquation","p1","p2","b","c","getRadiusForLine","line","buildEllipse","percentage","buildCircle","buildOffCircle","centerOffset","localRadius","FURTHEST","buildHeart","size","lineEquations","bottomCircleEquation","SQRT2","lobesRadius","lobesX","lobesSidesX","lobeCirclesEquations","lobesCentralEquation","lineEquation","lobeCircleEquation","sort","ray1","ray2","buildPolygon","sides","interiorAngle","circleDistance","circles","isCircleRadiusValid","intersection","circleAngle","localAngle","circle","circleRadius","buildOffPolygon","offset","realCenter","buildRandom","range","vnoise","seed","random","noise","fractal2d","computeRayPoint","computeDistanceSquared","point1","point2","controlId","EGearShape","EDisplayStyle","ETeethSize","callCallbacks","callbacks","callback","onDisplayStyleChange","Parameters","Page","Select","addObserver","onGearShapeChange","Checkbox","Button","onReset","onDownload","gearShapes","Object","values","gearShape","setValue","updateShiftCenterControl","setChecked","Tabs","rotationSpeed","Range","getValue","shiftCenter","CIRCLE","OFF_CIRCLE","TRIANGLE","OFF_TRIANGLE","SQUARE","OFF_SQUARE","PENTAGON","OFF_PENTAGON","displayStyle","getValues","showRays","isChecked","showTeeth","teethSize","updateTeethSizeControls","Controls","setVisibility","visible","rand","RandomScene","Scene","svgCanvas","centralGear","bestScene","scene","secondaryGears","ELLIPSE","PolarCurves","HEART","RANDOM","super","create","viewportWidth","width","viewportHeight","height","allGears","find","existingGear","newGear","tryBuildGear","removeFromArray","array","element","indexOf","splice","mainGear","mobileGear","updateStyle","flatStyle","FLAT","gearMainColor","axisColor","newStyle","setStyle","onMouseMove","getMousePosition","removeChild","hoveredGear","getHoveredGear","addChild","cursor","onMouseUp","onMouseUpRight","event","button","newSecondaryGears","gear","dt","secondaryGear","attach","detach","Canvas","Observers","mouseMove","mouseUp","closestGear","findClosestGear","slaveGear","e","console","debug","SMALL","MEDIUM","hoveredOpacity","performance","now","toFixed","style","opacity","mousePosition","lowestDistance","aspectRatio","getAspectRatio","SvgCanvas","svg","top","left","pointerEvents","styleElement","backgroundElement","adjustAspectRatio","canvasResize","canvasContainer","getCanvasContainer","insertBefore","getCanvas","addEventListener","observer","preventDefault","clear","child","firstChild","download","content","outerHTML","removeAttribute","downloadTextFile","innerHTML","distanceSquared","squared","fileName","fileType","blob","Blob","type","window","navigator","msSaveBlob","objectUrl","URL","createObjectURL","linkElement","createElement","href","dataset","display","body","click","setTimeout","revokeObjectURL","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","exports","module","__webpack_modules__","call","resetScene","lastUpdate","requestAnimationFrame","mainLoop","main"],"sourceRoot":""}